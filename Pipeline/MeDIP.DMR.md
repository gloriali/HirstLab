## Step1. Generate MeDIP only fractional methylation calls
### Calculate MeDIP signal around CpGs 
+ Run `RegionsCoverageFromWigCalculator.jar` on MeDIP libraries for CpG +/- 25bp regions.
+ Input files:
    * CpG +/- 25bp regions for each chr bed files: `/projects/epigenomics/mbilenky/CpG/hg19/CG_25_around_chr/`
    * MeDIP wig file        
+ Output files:   
    * `<chr>.<name>.coverage` file for each chr in each library: `chr   start   end     normalized coverage     max coverage`
    * `<chr>.<name>.cov` simplified file for Matlab input: `chr_start   normalized coverage`
+ Sample code:
```
JAVA=/gsc/software/linux-x86_64/jre1.7.0_03/bin/java
LIB=/home/mbilenky/bin/Solexa_Java
csizes=/projects/epigenomics/resources/UCSC_chr/hg19.chrom.sizes
dirr=/projects/epigenomics/mbilenky/CpG/hg19/CG_25_around_chr/
dirw=/projects/mbilenky/REMC/brain/MeDIP/wigs/

for name in "HS2788.MeDIP.Brain01.q5.F1028.SET_174" "HS2790.MeDIP.Brain02.q5.F1028.SET_174" "HS2775.MeDIP.NeurospheresCortex01.q5.F1028.SET_174" "HS2779.MeDIP.NeurospheresCortex02.q5.F1028.SET_174" "HS2777.MeDIP.NeurospheresGE01.q5.F1028.SET_157" "HS2781.MeDIP.NeurospheresGE02.q5.F1028.SET_166"
do
    echo "$name"
    out="/projects/epigenomics/lli/FetalBrain/MeDIP/CG_25_around_chr/"$name
    mkdir -p $out
    for chr in {1..22} "X" "Y" 
    do
        chr="chr"$chr
        echo "$chr"
        mkdir -p $out/$chr
        $JAVA -jar -Xmx15G $LIB/RegionsCoverageFromWigCalculator.jar -w $dirw/$name.wig.gz -r $dirr/$chr.gz -o $out/$chr -s $csizes -n $name
        less $out/$chr/*.coverage | awk '{gsub("chr", "", $1); print $1"_"$2"\t"$4}' > $out/$chr/$chr"."$name.cov
    done
done
```

### Generate MeDIP only fractional methylation calls
+ Run Matlab function by Misha: `medip_score2`
+ Input files:    
    * Signal file: `<chr>.<name>.cov` file generated in previous step    
    * Background file: coverage for CpG depleted regions, generated by Misha
+ Output files:
    * CDF plot for fractional methylation calls per chr
    * Fractional methylation calls per chr: `<chr>.<name>.dip` file: `chr_start   fractional calls`
+ Sample code: (Matlab: `/gsc/software/linux-x86_64-centos5/matlab-2012b/bin/matlab`)
```
addpath /home/mbilenky/matlab/dmr -end

close all; clear all;
set(0,'defaultaxesfontsize',18,'defaultlinelinewidth',2);
names={'HS2788.MeDIP.Brain01.q5.F1028.SET_174','HS2790.MeDIP.Brain02.q5.F1028.SET_174','HS2775.MeDIP.NeurospheresCortex01.q5.F1028.SET_174','HS2779.MeDIP.NeurospheresCortex02.q5.F1028.SET_174','HS2777.MeDIP.NeurospheresGE01.q5.F1028.SET_157','HS2781.MeDIP.NeurospheresGE02.q5.F1028.SET_166'};
chrs={'chr1','chr2','chr3','chr4','chr5','chr6','chr7','chr8','chr9','chr10','chr11','chr12','chr13','chr14','chr15','chr16','chr17','chr18','chr19','chr20','chr21','chr22','chrX','chrY'};

for i = 1:6
    name=names{1,i};name1 = regexprep(name, '.q5.F1028.SET_[0-9]+', '')
    for j = 1:24
        chr=chrs{1,j}
        close all; 
        [l,cc] = textread(['/projects/epigenomics/lli/FetalBrain/MeDIP/CG_25_around_chr/',name,'/',chr,'/',chr,'.',name,'.cov'],'%s %f');
        [c,n,cn]=textread(['/projects/mbilenky/REMC/brain/MeDIP/analysis/CpG_empty_500_coverage/',chr,'/',chr,'.gz.',name1,'.covDist'],'%f %f %f');
         
        x=c;
        y=cn/max(cn);
        z=cc;
        dip=medip_score2(x,y,z);
        
        figure('visible','off');box;
        cdfplot(dip);
        xlabel('Fractional methylation');
        ylabel('Fraction of CpGs');
        title(strcat(name1,'.',chr));
        dirOut='/projects/epigenomics/lli/FetalBrain/MeDIP/CDF_5mC_plots/';
        nameOut=strcat(dirOut, 'CDF_5mC_',name1,'.',chr);
        print(gcf, '-dpdf', strcat(nameOut, '.pdf'));
         
        t=size(dip); n=t(2);
        fileOut = fopen(strcat('/projects/epigenomics/lli/FetalBrain/MeDIP/CG_25_around_chr/',name,'/',chr,'/',chr,'.',name,'.dip'),'w');
        for i=1:n
        fprintf(fileOut,'%s\t', l{i});
        fprintf(fileOut,'%7.3f\t',dip(i));
        fprintf(fileOut,'\n');
        end
        fclose(fileOut);
    end
end
```

### Combine MeDIP methylation calls from all chrs
+ For each sample, join all `<chr>.<name>.dip` files into one `<name>.dip` file    
+ Sample code:
```
cd /projects/epigenomics/lli/FetalBrain/MeDIP/CG_25_around_chr
out='/projects/epigenomics/lli/FetalBrain/MeDIP'
for name in "HS2788.MeDIP.Brain01.q5.F1028.SET_174" "HS2790.MeDIP.Brain02.q5.F1028.SET_174" "HS2775.MeDIP.NeurospheresCortex01.q5.F1028.SET_174" "HS2779.MeDIP.NeurospheresCortex02.q5.F1028.SET_174" "HS2777.MeDIP.NeurospheresGE01.q5.F1028.SET_157" "HS2781.MeDIP.NeurospheresGE02.q5.F1028.SET_166"
do
    echo "$name"
    cat ./$name/*/*.dip > $out/$name.dip
done
```

## Step2. DMR identification for pairwise comparisons
+ Parameters:
    * delta: minimum difference in fractional calls to call DM CpG    
    * size: max distance between two consecutive CpGs     
    * cut: minimum number of CpGs per DMR
+ Input files: `<name>.dip` file from each library
+ Output files:
    * `DMR.summary.stats`: `Samples   Delta   Size    Cut   Average length of DMRs    Average No.of CpGs per DMR    Total No.of DMRs      No.of hypermethylated DMRs    No.of hypomethylated DMRs`
    * `DM.<cell1>-<donor1>_<cell2>-<donor2>.d<delta>.bed `: DM CpGs: `chr   start   end     DM (hyper:1; hypo:-1)   mC1     mC2`
    * `DMR.<cell1>-<donor1>_<cell2>-<donor2>.d<delta>.s<size>.c<cut>`: DMRs: `chr   start   end     ID  DM (hyper:1; hypo:-1)   No.of CpGs     length`
    * `DMR.<cell1>-<donor1>_<cell2>-<donor2>.d<delta>.s<size>.c<cut>.hyper`: hypermethylated DMRs     
    * `DMR.<cell1>-<donor1>_<cell2>-<donor2>.d<delta>.s<size>.c<cut>.hypo`: hypomethylated DMRs     
+ Sample code:
```
delta=0.6 # minimum difference in fractional calls to call DM CpG
size=500  # max distance between two consecutive CpGs
cut=3     # minimum number of CpGs
cd /projects/epigenomics/lli/FetalBrain/MeDIP/
dirIn='/projects/epigenomics/lli/FetalBrain/MeDIP'
dirDM=$dirIn/DMR
mkdir -p $dirDM
>$dirDM/DMR.summary.stats # samples, delta, size, cut, Average length of DMRs, Average No.of CpGs per DMR, No.of DMRs, No.of hypermethylated DMRs, No.of hypomethylated DMRs    
lib1="HS2788"; cell1="Brain"; donor1="HuFNSC01"; name1="HS2788.MeDIP.Brain01.q5.F1028.SET_174";
lib2="HS2790"; cell2="Brain"; donor2="HuFNSC02"; name2="HS2790.MeDIP.Brain02.q5.F1028.SET_174";
dm=DM.$cell1"-"$donor1"_"$cell2"-"$donor2.d$delta.bed 
echo -e DMRs between $cell1"-"$donor1 and $cell2"-"$donor2: delta=$delta, size=$size, cut=$cut, output: chr"\t"start"\t"end"\t"ID"\t"DM"\t"No.of CpGs"\t"length
paste $dirIn/$name1.dip $dirIn/$name2.dip | awk -v delta=$delta '{if($1!=$3)print "Bad line", $0; chr="chr"gensub("_[0-9]+", "", "g", $1); start=gensub("[0-9XY]+_", "", "g", $1)+23; end=start+2; if($2-$4 > delta)print chr"\t"start"\t"end"\t1\t"$2"\t"$4; else if($2-$4 < -delta)print chr"\t"start"\t"end"\t-1\t"$2"\t"$4}' | sort -k1,1 -k2,2n > $dirDM/$dm
less $dirDM/$dm | grep 'Bad line'
less $dirDM/$dm | awk 'BEGIN{size="'$size'"+0; cut="'$cut'"+0} {if($2<end+size && $4==dm && $1==chr){end=$3;c=c+1} else {if(end!=null){if(c>cut){l=end-start;print chr"\t"start"\t"end"\t"chr":"start"-"end"\t"dm"\t"c"\t"l}}; chr=$1;start=$2;end=$3;c=1;dm=$4}}END{if(c>cut){l=end-start;print chr"\t"start"\t"end"\t"chr":"start"-"end"\t"dm"\t"c"\t"l}}' > $dirDM/DMR.$cell1"-"$donor1"_"$cell2"-"$donor2.d$delta.s$size.c$cut
less $dirDM/DMR.$cell1"-"$donor1"_"$cell2"-"$donor2.d$delta.s$size.c$cut | awk '{l=l+$7; c=c+$6; count++; if($5==1){hyper++;hyperlen=hyperlen+$7; print $0 >> "'$dirDM'""/DMR.""'$cell1'""-""'$donor1'""_""'$cell2'""-""'$donor2'"".d""'$delta'"".s""'$size'"".c""'$cut'"".hyper"} else {print $0 >> "'$dirDM'""/DMR.""'$cell1'""-""'$donor1'""_""'$cell2'""-""'$donor2'"".d""'$delta'"".s""'$size'"".c""'$cut'"".hypo"}} END {print "'$cell1'""-""'$donor1'""_""'$cell2'""-""'$donor2'""\t""'$delta'""\t""'$size'""\t""'$cut'""\t"l/count"\t"c/count"\t"count"\t"hyper"\t"count-hyper}' >> $dirDM/DMR.summary.stats
```





